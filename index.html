<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ステータスジェネレーター</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    input, select, button {
      font-size: 1rem;
      margin: 5px;
    }
    .output {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>ステータスジェネレーター</h1>

  <label for="name">名前: </label>
  <input type="text" id="name" placeholder="キャラクター名"><br>

  <label for="rank">階級 (1以上): </label>
  <input type="number" id="rank" min="1" value="1"><br>

  <label for="build">ビルドタイプ: </label>
  <select id="build"></select><br>

  <button id="generateBtn" type="button" onclick="generate()" disabled>ステータス生成</button>

  <div class="output" id="output"></div>

  <script>
    let titles = [];
    let buildTypes = {};
    let skills = {};
    let formulas = {};

    // JSONの読み込み
    Promise.all([
      fetch("titles.json").then(res => res.json()),
      fetch("buildTypes.json").then(res => res.json()),
      fetch("skills.json").then(res => res.json()),
      fetch("formulas.json").then(res => res.json())
    ])
    .then(([t, b, s, f]) => {
      titles = t;
      buildTypes = b;
      skills = s;
      formulas = f;

      const buildSelect = document.getElementById("build");
      const randomOpt = document.createElement("option");
      randomOpt.value = "__RANDOM__";
      randomOpt.textContent = "ランダム";
      randomOpt.selected = true;
      buildSelect.appendChild(randomOpt);

      for (const key in buildTypes) {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        buildSelect.appendChild(opt);
      }

      document.getElementById("generateBtn").disabled = false;
    });

function evalFormula(expr, S, rank) {
  const random = (min, max) => {
    // スケーリング上限を階級に応じて拡張
    const scaledMax = Math.floor(max * (1 + rank / 10)); // 例: rank 10 → 2倍
    return Math.floor(Math.random() * (scaledMax - min + 1)) + min;
  };

  try {
    return Function("S", "random", `"use strict"; return (${expr});`)(S, random);
  } catch (e) {
    console.error("式の評価中にエラー:", expr, e);
    return "計算エラー";
  }
}

    function chooseFormulaWeighted() {
      const table = [
        { name: "Burst", weight: 30 },
        { name: "Balance", weight: 30 },
        { name: "Control", weight: 20 },
        { name: "Rage", weight: 15 },
        { name: "Gamble", weight: 5 }
      ];
      const total = table.reduce((sum, item) => sum + item.weight, 0);
      let roll = Math.random() * total;
      for (const item of table) {
        if (roll < item.weight) return item.name;
        roll -= item.weight;
      }
    }

    function generateStatus(rank, buildType) {
      const basePoints = rank * 50;
      const minPoints = Math.floor(basePoints * 0.8);
      const maxPoints = Math.ceil(basePoints * 1.5);
      const totalPoints = Math.floor(Math.random() * (maxPoints - minPoints + 1)) + minPoints;

      const ratio = buildTypes[buildType];
      const rawDistribution = {};
      let used = 0;

      for (const key in ratio) {
        const val = Math.floor(totalPoints * ratio[key]);
        rawDistribution[key] = val;
        used += val;
      }

      rawDistribution["記憶力"] += totalPoints - used;

      const finalStatus = {
        HP: rawDistribution.HP * 3,
        MP: rawDistribution.MP * 3,
        ATK: rawDistribution.ATK,
        DEF: rawDistribution.DEF,
        DEX: rawDistribution.DEX,
        記憶力: Math.floor(rawDistribution["記憶力"] / 5)
      };

      return { rank, totalPoints, buildType, rawDistribution, finalStatus };
    }

    function showSkills(buildType, status, memoryCount) {
      const skillList = skills[buildType] || [];
      const selected = [...skillList].sort(() => Math.random() - 0.5).slice(0, memoryCount);
      let html = "";

      selected.forEach(skill => {
        let formulaName = skill.formula === "random" ? chooseFormulaWeighted() : skill.formula;
        const formula = formulas[formulaName];
        const S = status[skill.scaling];
        const damage = evalFormula(formula.damage, S);
        const cost = evalFormula(formula.cost, S);

        html += `✨ スキル: ${skill.name}（${skill.category}）\n`;
        html += `⚡ 効果: ${skill.effect}\n`;
        html += `📏 射程: ${skill.range}\n`;
        html += `⚔️ 威力: ${damage} / MP消費: ${cost}（式: ${formulaName}）\n\n`;
      });

      return html;
    }

    function generate() {
      const name = document.getElementById("name").value.trim() || "名無し";
      const rank = parseInt(document.getElementById("rank").value, 10);
      let buildType = document.getElementById("build").value;
      if (buildType === "__RANDOM__") {
        const keys = Object.keys(buildTypes);
        buildType = keys[Math.floor(Math.random() * keys.length)];
      }

      const result = generateStatus(rank, buildType);
      const title = titles[Math.floor(Math.random() * titles.length)];
      const output = document.getElementById("output");

      output.innerHTML =
        `👤 名前: ${name}、${title}\n` +
        `🏷️ ビルドタイプ: ${result.buildType}\n` +
        `🔹 階級: ${result.rank}\n` +
        `🔸 使用ポイント: ${result.totalPoints}\n\n` +
        `🎲 振り分け:\n` +
        Object.entries(result.rawDistribution).map(([k, v]) => `${k}: ${v}`).join("\n") +
        `\n\n📊 最終ステータス:\n` +
        Object.entries(result.finalStatus).map(([k, v]) => `${k}: ${v}`).join("\n") +
        `\n\n` +
        showSkills(result.buildType, result.finalStatus, result.finalStatus.記憶力);
    }
  </script>
</body>
</html>
