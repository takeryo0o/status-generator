<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå®Œå…¨è‡ªå‹•ã‚¹ã‚­ãƒ«ç”Ÿæˆãƒ»å…¨ãƒ“ãƒ«ãƒ‰å¯¾å¿œï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    input, select, button, textarea {
      font-size: 1rem;
      margin: 5px;
    }
    .output {
      margin-top: 20px;
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆå…¨ãƒ“ãƒ«ãƒ‰å¯¾å¿œï¼‰</h1>

  <label for="name">åå‰: </label>
  <input type="text" id="name" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å"><br>

  <label for="rank">éšç´š (1ä»¥ä¸Š): </label>
  <input type="number" id="rank" min="1" value="1"><br>

  <label for="build">ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—: </label>
  <select id="build"></select><br>

  <button id="generateBtn" type="button" onclick="generate()" disabled>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ</button>

  <div class="output" id="output"></div>

  <script>
    let titles = [], buildTypes = {}, formulas = {};
    let magicPrefixes = [], magicSuffixes = [], meleePrefixes = [], meleeSuffixes = [];
    let tankPrefixes = [], tankSuffixes = [], supportPrefixes = [], supportSuffixes = [];

    function randomFrom(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function evalFormula(expr, S, rank) {
      const random = (min, max) => {
        const scaledMax = Math.floor(max * (1 + rank / 10));
        return Math.floor(Math.random() * (scaledMax - min + 1)) + min;
      };
      try {
        return Function("S", "random", `"use strict"; return (${expr});`)(S, random);
      } catch (e) {
        console.error("å¼ã®è©•ä¾¡ã‚¨ãƒ©ãƒ¼:", expr, e);
        return "è¨ˆç®—ã‚¨ãƒ©ãƒ¼";
      }
    }

    function chooseFormulaWeighted() {
      const table = [
        { name: "Burst", weight: 30 },
        { name: "Balance", weight: 30 },
        { name: "Control", weight: 20 },
        { name: "Rage", weight: 15 },
        { name: "Gamble", weight: 5 }
      ];
      const total = table.reduce((sum, item) => sum + item.weight, 0);
      let roll = Math.random() * total;
      for (const item of table) {
        if (roll < item.weight) return item.name;
        roll -= item.weight;
      }
    }

    function generateRandomSkill(status, rank, buildType) {
      const descTemplates = [
        "{prefix}ã®{suffix}ã§æ•µã‚’è²«ãã€‚",
        "{prefix}{suffix}ã‚’è§£ãæ”¾ã¡ã€å‰æ–¹ã‚’ä¸€æƒã™ã‚‹ã€‚",
        "{prefix}ã®åŠ›ãŒå®¿ã‚‹{suffix}ã‚’å©ãè¾¼ã‚€ã€‚",
        "å¼·çƒˆãª{prefix}{suffix}ã§ç›¸æ‰‹ã‚’æ‰“ã¡ã®ã‚ã™ã€‚",
        "{prefix}{suffix}ã‚’æ”¾ã¡ã€æ•µã«é‡åœ§ã‚’ä¸ãˆã‚‹ã€‚"
      ];

      let prefixes = [], suffixes = [];

      if (buildType === "é­”æ³•å‹") {
        prefixes = magicPrefixes;
        suffixes = magicSuffixes;
      } else if (buildType === "è¿‘æ¥å‹") {
        prefixes = meleePrefixes;
        suffixes = meleeSuffixes;
      } else if (buildType === "ã‚¿ãƒ³ã‚¯å‹") {
        prefixes = tankPrefixes;
        suffixes = tankSuffixes;
      } else if (buildType === "è£œåŠ©å‹") {
        prefixes = supportPrefixes;
        suffixes = supportSuffixes;
      }

      const prefix = randomFrom(prefixes);
      const suffix = randomFrom(suffixes);
      const name = prefix + suffix;
      const description = randomFrom(descTemplates).replace("{prefix}", prefix).replace("{suffix}", suffix);
      const range = randomFrom(["å‰æ–¹1ãƒã‚¹", "å‰æ–¹3ãƒã‚¹", "è‡ªåˆ†ä¸­å¿ƒ2ãƒã‚¹", "ç›´ç·š4ãƒã‚¹", "è‡ªåˆ†ã®ã¿"]);
      const scalingOptions = ["MP", "ATK", "è¨˜æ†¶åŠ›"];
      const scaling = randomFrom(scalingOptions);
      const formulaName = chooseFormulaWeighted();
      const formula = formulas[formulaName];
      const S = status[scaling] ?? 0;
      const damage = evalFormula(formula.damage, S, rank);
      const cost = evalFormula(formula.cost, S, rank);

      return {
        name, description, range, scaling, formula: formulaName, damage, cost
      };
    }

    function generateStatus(rank, buildType) {
      const basePoints = rank * 50;
      const minPoints = Math.floor(basePoints * 0.8);
      const maxPoints = Math.ceil(basePoints * 1.5);
      const total = Math.floor(Math.random() * (maxPoints - minPoints + 1)) + minPoints;
      const ratio = buildTypes[buildType];
      const raw = {};
      for (const key in ratio) raw[key] = Math.floor(total * ratio[key]);
      const rest = total - Object.values(raw).reduce((a, b) => a + b, 0);
      raw["è¨˜æ†¶åŠ›"] += rest;
      const final = {
        HP: raw.HP * 3, MP: raw.MP * 3, ATK: raw.ATK, DEF: raw.DEF, DEX: raw.DEX,
        è¨˜æ†¶åŠ›: Math.floor(raw["è¨˜æ†¶åŠ›"] / 5)
      };
      return { rank, totalPoints: total, buildType, rawDistribution: raw, finalStatus: final };
    }

    function generate() {
      const name = document.getElementById("name").value.trim() || "åç„¡ã—";
      const rank = parseInt(document.getElementById("rank").value, 10);
      let buildType = document.getElementById("build").value;
      if (buildType === "__RANDOM__") {
        const keys = Object.keys(buildTypes);
        buildType = keys[Math.floor(Math.random() * keys.length)];
      }

      const result = generateStatus(rank, buildType);
      const title = randomFrom(titles);
      const output = document.getElementById("output");

      let html = `ğŸ‘¤ åå‰: ${name}ã€${title}
ğŸ·ï¸ ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—: ${result.buildType}
ğŸ”¹ éšç´š: ${result.rank}
ğŸ”¸ ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆ: ${result.totalPoints}

ğŸ² æŒ¯ã‚Šåˆ†ã‘:
`;
      for (const [k, v] of Object.entries(result.rawDistribution)) html += `${k}: ${v}
`;
      html += `
ğŸ“Š æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
`;
      for (const [k, v] of Object.entries(result.finalStatus)) html += `${k}: ${v}
`;
      html += `
ğŸ§ª è‡ªå‹•ç”Ÿæˆã‚¹ã‚­ãƒ«:
`;

      for (let i = 0; i < result.finalStatus.è¨˜æ†¶åŠ›; i++) {
        const sk = generateRandomSkill(result.finalStatus, result.rank, buildType);
        html += `âœ¨ ã‚¹ã‚­ãƒ«å: <input type="text" value="${sk.name}">ï¼ˆ${buildType}ï¼‰
`;
        html += `ğŸ“ èª¬æ˜: <textarea rows="2" cols="40">${sk.description}</textarea>
`;
        html += `ğŸ“ å°„ç¨‹: ${sk.range}
`;
        html += `âš– ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°: ${sk.scaling}
`;
        html += `âš” å¨åŠ›: ${sk.damage} / ğŸ”‹ MPæ¶ˆè²»: ${sk.cost}ï¼ˆå¼: ${sk.formula}ï¼‰

`;
      }

      output.innerHTML = html;
    }

    Promise.all([
      fetch("titles.json").then(res => res.json()),
      fetch("buildTypes.json").then(res => res.json()),
      fetch("formulas.json").then(res => res.json()),
      fetch("prefixes.json").then(res => res.json()),
      fetch("suffixes.json").then(res => res.json()),
      fetch("melee_prefixes.json").then(res => res.json()),
      fetch("melee_suffixes.json").then(res => res.json()),
      fetch("tank_prefixes.json").then(res => res.json()),
      fetch("tank_suffixes.json").then(res => res.json()),
      fetch("support_prefixes.json").then(res => res.json()),
      fetch("support_suffixes.json").then(res => res.json())
    ]).then(([
      t, b, f,
      magp, mags, mp, ms,
      tp, ts, sp, ss
    ]) => {
      titles = t;
      buildTypes = b;
      formulas = f;
      magicPrefixes = magp;
      magicSuffixes = mags;
      meleePrefixes = mp;
      meleeSuffixes = ms;
      tankPrefixes = tp;
      tankSuffixes = ts;
      supportPrefixes = sp;
      supportSuffixes = ss;

      const buildSelect = document.getElementById("build");
      const opt = document.createElement("option");
      opt.value = "__RANDOM__";
      opt.textContent = "ãƒ©ãƒ³ãƒ€ãƒ ";
      opt.selected = true;
      buildSelect.appendChild(opt);
      for (const key in buildTypes) {
        const o = document.createElement("option");
        o.value = key;
        o.textContent = key;
        buildSelect.appendChild(o);
      }

      document.getElementById("generateBtn").disabled = false;
    });
  </script>
</body>
</html>
